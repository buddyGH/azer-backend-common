## 1.项目结构

### 1.示例项目结构
```
azer_common/
├── config/                  # 通用配置模块：跨微服务的配置加载/验证逻辑
├── databases/               # 通用数据库模块：跨微服务的数据库/缓存/消息队列连接逻辑
├── exceptions/              # 通用异常模块：跨微服务的异常定义与统一处理逻辑
├── middlewares/             # 通用中间件模块：跨微服务的请求/响应拦截逻辑
├── models/                  # 通用模型模块：跨微服务的ORM基类定义
├── services/                # 通用服务模块：无业务属性的公共服务逻辑（认证、存储等）
├── tasks/                   # 通用任务模块：跨微服务的异步任务基础逻辑
└── utils/                   # 通用工具模块：无业务属性的公共工具函数（加密、时间、HTTP等）
```



## 一、模型层测试（Tortoise ORM）

### 1. 模型定义测试

- **字段验证**：测试每个字段的类型、约束条件（nullable、unique、max_length等）
- **关系测试**：外键关系、一对一、一对多、多对多关系是否正确建立
- **属性方法**：模型类中定义的计算属性、自定义方法
- **元配置**：表名、索引、约束条件等元数据设置

### 2. 模型方法测试

- **CRUD操作**：create、update、delete、get等基础操作
- **查询方法**：filter、exclude、annotate等查询条件
- **预取相关**：prefetch_related的使用效果
- **自定义查询**：模型中定义的类方法或管理器方法

## 二、数据访问层测试

### 1. Repository/DAO层测试（如果分层）

- **数据操作逻辑**：复杂查询、事务处理、批量操作
- **数据验证**：业务规则在数据层的实现
- **异常处理**：数据库异常、约束违反的捕获和处理

### 2. 数据库连接测试

- **连接管理**：连接池、重连机制
- **迁移测试**：模型变更后的迁移脚本
- **事务隔离**：不同事务级别的行为

## 三、服务层测试

### 1. 业务逻辑测试

- **核心业务逻辑**：主要功能点的实现
- **数据处理**：输入数据的清洗、转换、验证
- **状态流转**：业务对象的状态变化
- **权限验证**：业务级别的权限控制

### 2. 服务方法测试

- **方法功能**：每个公共方法的输入输出
- **错误处理**：业务异常、参数错误
- **依赖调用**：对其他服务或repository的调用

## 四、API端点测试

### 1. 路由测试

- **路径参数**：不同类型的路径参数解析
- **查询参数**：可选参数、必填参数、默认值
- **请求体**：Pydantic模型验证、嵌套结构
- **响应格式**：状态码、响应体结构、错误格式

### 2. HTTP方法测试

- **GET请求**：列表查询、详情查询、分页、排序、过滤
- **POST请求**：创建资源、参数验证、数据持久化
- **PUT/PATCH请求**：更新操作、部分更新、乐观锁
- **DELETE请求**：删除操作、级联删除、软删除

## 五、中间件和依赖项测试

### 1. 依赖注入测试

- **自定义依赖**：认证、权限、数据库会话等依赖
- **依赖覆盖**：测试环境下依赖的mock或替换
- **依赖组合**：多个依赖的叠加效果

### 2. 中间件测试

- **请求处理**：认证中间件、日志中间件、CORS等
- **响应处理**：响应头设置、异常处理中间件
- **性能监控**：请求耗时、数据库查询监控

## 六、认证授权测试

### 1. 认证测试

- **认证方式**：JWT、OAuth2、API Key等
- **Token处理**：Token生成、验证、刷新、过期
- **密码安全**：密码哈希、验证

### 2. 授权测试

- **权限控制**：基于角色、基于资源的权限控制
- **访问限制**：API限流、操作频率限制
- **数据隔离**：用户数据隔离、多租户数据隔离

## 七、集成相关测试

### 1. 数据库集成测试

- **连接测试**：数据库连接、断开重连
- **事务测试**：嵌套事务、事务回滚
- **迁移测试**：数据库迁移脚本

### 2. 外部依赖测试（如果使用）

- **缓存测试**：Redis等缓存操作
- **消息队列**：异步任务处理
- **文件存储**：文件上传、下载、存储

## 八、异常和边界测试

### 1. 异常处理测试

- **业务异常**：自定义业务异常的处理
- **系统异常**：数据库异常、网络异常、超时
- **验证异常**：输入验证失败、格式错误

### 2. 边界条件测试

- **数据边界**：空数据、极大值、极小值
- **并发测试**：并发创建、更新竞争条件
- **性能边界**：大数据量查询、分页极限

## 九、配置和环境测试

### 1. 配置测试

- **环境配置**：不同环境（开发、测试、生产）的配置切换
- **特性开关**：功能开关、A/B测试配置
- **安全配置**：CORS、安全头、HTTPS重定向

## 测试分类建议：

1. **单元测试**：模型方法、服务方法、工具函数
2. **集成测试**：API端点、数据库操作、外部服务调用
3. **契约测试**：API响应格式、数据契约
4. **性能测试**：数据库查询性能、API响应时间

测试时应特别注意：

- 使用测试数据库，避免污染生产数据
- Mock外部依赖，保证测试的独立性和速度
- 覆盖正常流程和异常流程
- 关注事务一致性和数据完整性